import os
import pickle

# Gets the absolute directory path where this script file lives
BASE_DIR = os.path.dirname(os.path.abspath(__file__))

# Builds a normalized path to the sibling ../app directory (where the storage folder exists)
APP_DIR = os.path.normpath(os.path.join(BASE_DIR, "..", "app"))

# Points to the pickled users database inside app/storage/
USERS_PATH = os.path.join(APP_DIR, "storage", "users.pkl")

# Points to the pickled notes database inside app/storage/
NOTES_PATH = os.path.join(APP_DIR, "storage", "notes.pkl")

# Loads a pickle file from disk and returns the deserialized Python object (or None on error)
def load_pickle(path: str):
    print(f"[*] Loading: {path}")
    if not os.path.exists(path):
        print(f"[!] ERROR: {path} not found.")
        return None
    with open(path, "rb") as f:
        return pickle.load(f)

# Prints user records in a human-readable form, supporting dict- or list-based schemas
def dump_users(data):
    print("\nUSERS DUMP: ")

    if data is None:
        print("[!] No user data.")
        return

    # If users are stored as a dict (username -> record), iterate using items()
    if isinstance(data, dict):
        iterable = data.items()
    else:  # list or whatever
        iterable = [(u.get("username"), u) for u in data]

    for username, info in iterable:
        if not info:
            continue
        
        # Reads the stored password hash 
        pw_hash = info.get("password")          # SHA-256 hash
        pw_plain = info.get("plain_password")   # may be None for old users
        role = info.get("role")

        print(f"User: {username}")
        print(f"  Role: {role}")
        print(f"  Plaintext Password: {repr(pw_plain) if pw_plain is not None else '<not stored>'}")
        print(f"  Password Hash: {pw_hash}")
        print()

# Prints notes grouped by user, expecting a dict of username -> list[note_dict]
def dump_notes(data):
    print("\nNOTES DUMP: ")

    if data is None:
        print("[!] No notes data.")
        return

    if not isinstance(data, dict):
        print(f"[!] Unexpected notes type: {type(data)}")
        return

    for username, notes in data.items():
        print(f"\nUser: {username}")
        if not notes:
            print("  (no notes)")
            continue

        for i, note in enumerate(notes):
            title = note.get("title", f"Note {i}")
            content = note.get("content", "")
            print(f"  [{i}] {title}")
            print(f"      {content}")

# Coordinates loading and dumping both users and notes
def main():
    users = load_pickle(USERS_PATH)
    dump_users(users)

    notes = load_pickle(NOTES_PATH)
    dump_notes(notes)


if __name__ == "__main__":
    main()
