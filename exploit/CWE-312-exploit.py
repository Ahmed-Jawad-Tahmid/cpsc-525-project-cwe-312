import os
import pickle

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
APP_DIR = os.path.normpath(os.path.join(BASE_DIR, "..", "app"))

USERS_PATH = os.path.join(APP_DIR, "storage", "users.pkl")
NOTES_PATH = os.path.join(APP_DIR, "storage", "notes.pkl")


def load_pickle(path: str):
    print(f"[*] Loading: {path}")
    if not os.path.exists(path):
        print(f"[!] ERROR: {path} not found.")
        return None
    with open(path, "rb") as f:
        return pickle.load(f)


def dump_users(data):
    print("\n==================== USERS DUMP ====================")

    if data is None:
        print("[!] No user data.")
        return

    # Your storage is a list of dicts: [{"username": ..., "password": ..., "plain_password": ..., "role": ...}, ...]
    if isinstance(data, dict):
        iterable = data.items()
    else:  # list or whatever
        iterable = [(u.get("username"), u) for u in data]

    for username, info in iterable:
        if not info:
            continue

        pw_hash = info.get("password")          # SHA-256 hash
        pw_plain = info.get("plain_password")   # may be None for old users
        role = info.get("role")

        print(f"User: {username}")
        print(f"  Role: {role}")
        print(f"  Plaintext Password: {repr(pw_plain) if pw_plain is not None else '<not stored>'}")
        print(f"  Password Hash: {pw_hash}")
        print()


def dump_notes(data):
    print("\n==================== NOTES DUMP ====================")

    if data is None:
        print("[!] No notes data.")
        return

    if not isinstance(data, dict):
        print(f"[!] Unexpected notes type: {type(data)}")
        return

    for username, notes in data.items():
        print(f"\nUser: {username}")
        if not notes:
            print("  (no notes)")
            continue

        for i, note in enumerate(notes):
            title = note.get("title", f"Note {i}")
            content = note.get("content", "")
            print(f"  [{i}] {title}")
            print(f"      {content}")


def main():
    users = load_pickle(USERS_PATH)
    dump_users(users)

    notes = load_pickle(NOTES_PATH)
    dump_notes(notes)


if __name__ == "__main__":
    main()
